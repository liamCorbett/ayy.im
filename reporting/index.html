<!DOCTYPE html>
<html>

  <head>

    <base target="_top">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-+0n0xVW2eSR5OomGNYDnhzAbDsOXxcvSN1TPprVMTNDbiYZCxYbOOl7+AMvyTG2x" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.1/dist/js/bootstrap.bundle.min.js" integrity="sha384-gtEjrD/SeCtmISkJkNUaaKMoLD0//ElJ19smozuHV6z3Iehds+3Ulb9Bn9Plx0x4" crossorigin="anonymous"></script>


    <style>
      div#img-previews {
        display: none;
        width: 100%;
        margin-bottom: 22px;
        flex-wrap: wrap;
      }

      div.img-preview-container {
        height: 100px; /* Can be anything */
        min-width: 100px;
        width: 100px; /* Can be anything */
        position: relative;
        border: 1px solid #ced4da;
        background-color: #eee;
      }

      img.img-preview {
        max-height: 100%;
        max-width: 100%;
        width: auto;
        height: auto;
        position: absolute;
        top: 0;
        bottom: 0;
        left: 0;
        right: 0;
        margin: auto;
      }

      div.container {
        margin: 0 auto; 
        padding: 20px 30px 40px; 
        background-color: #fff; 
        max-width: 100%;
        width: 100%;
      }


      @media only screen and (min-width: 800px) {
        div.container {
        }
      }

      @media only screen and (min-width: 801px) {
        div.container {
          max-width: 662px; 
          width: 100%;
          margin-top: 20px; 
          border-radius: 1.5px; 
          border: 1px solid #dadce0;
        }
      }
    </style>
  </head>

  <body style="background-color: #ff585b;">

    <div class="container">
      <div class="row">
        <h1>r/MeetPeople Report</h1><br/>

        <form id="form">

          <!-- <label for="complainant" class="form-label">Who are you?</label>
          <input name="complainant" id="complainant" type="text" placeholder="optional" class="form-control"><br/> -->

          <label for="complainee" class="form-label">Who are you reporting?</label>
          <input name="complainee" id="complainee" type="text" placeholder="optional" class="form-control"><br/>

          <label for="url" class="form-label">URL of problem:</label><br/>
          <input name="url" id="url" type="url" placeholder="optional" class="form-control"><br/>

          <label for="reason" class="form-label">Reason for report:</label><br/>
          <select name="reason" id="reason" class="form-select">

            <option value="Not Specified" selected>Not Specified</option>

            <optgroup label="Reddit's Terms of Service">
              <option value="Harassment, bullying, threats of violence">Harassment, bullying, threats of violence</option>
              <option value="Content cheating, spamming, manipulation">Content cheating, spamming, manipulation</option>
              <option value="Infringes on privacy">Infringes on privacy</option>
              <option value="Suggestive toward minors">Suggestive toward minors</option>
              <option value="Impersonation">Impersonation</option>
              <option value="Unmarked NSFW content">Unmarked NSFW content</option>
              <option value="Breaks the law">Breaks the law</option>
              <option value="Breaks the site">Breaks the site</option>
            </optgroup>

            <optgroup label="r/MeetPeople Rules">
              <option value="Posts must contain a tag">1. Posts must contain a tag</option>
              <option value="One post per day">2. One post per day!</option>
              <option value="Don't be lewd / NSFW">3. Don't be lewd / NSFW</option>
              <option value="Don't post public contact info / invite links">4. Don't post public contact information, or invite links</option>
              <option value="Don't message minors as an adult">5. Don't message minors as an adult</option>
              <option value="Don't seek relationships if under 16">6. Don't seek relationships if under 16</option>
              <option value="Don't advertise or matchmake">7. Don't advertise or "matchmake"</option>
              <option value="Respect the community">8. Respect the community</option>
            </optgroup>

            <!-- <optgroup label="r/MeetPeople Rules">
              <option value="Reddit's Terms of Service">1. Reddit's Terms of Service</option>
              <option value="Posts must contain a tag">2. Posts must contain a tag</option>
              <option value="No Advertisements">3. No Advertisements</option>
              <option value="No Matchmakers">4. No Matchmakers</option>
              <option value="No Public Invite Links">5. No Public Invite Links</option>
              <option value="No Relationships under 16">6. No Relationships under 16</option>
              <option value="Be Respectful">7. Be Respectful</option>
              <option value="No NSFW submissions">8. No NSFW submissions</option>
              <option value="Keep personal/contact info in DMs">9. Keep personal/contact info in DMs</option>
            </optgroup> -->

            <optgroup label="Other">
              <option value="Other">Other</option>
            </optgroup>

          </select><br/>

          <label for="description" class="form-label">Problem description:</label><br/>
          <textarea name="description" id="description" placeholder="optional" cols="40" class="form-control" data-bs-toggle="tooltip" data-bs-placement="right" title="(you can include your username here if you'd like)"></textarea><br/>

          <label for="files" class="form-label">Screenshots, files, images:</label><br/>
          <!-- <input name="files" id="uploadfiles" type="file" multiple="multiple" onchange="document.getElementById('preview1').src = window.URL.createObjectURL(this.files[0]); document.getElementById('preview1').style = 'display: block; width: auto; max-width: 100px; height: auto; max-height: 100px;'"><br/><br/> -->
          <input name="files" id="uploadfiles" type="file" multiple="multiple" onchange="createPreviews(event)"><br/><br/>
          <div id="img-previews"></div>

          <input id="submit" type="submit" value="Submit Anonymously" class="btn btn-primary" style="margin-bottom: 5px;"><br/>
          <input id="submitReddit" type="submit" value="Submit with Reddit" class="btn btn-light" disabled> (coming soon)

        </form>

      </div>
    </div>



    <!-- <img src="https://i.imgur.com/bIRPGvo.png" style="position:absolute; top:10rem; left:8rem; z-index: -1;"> -->
    <img src="https://i.imgur.com/MdsEwkG.png" style="position:absolute; top:10rem; left:8rem; z-index: -1;">

    <img src="https://www.redditstatic.com/avatars/avatar_default_07_FF585B.png" style="position:absolute; bottom:0; right:0; z-index: -1;">

    <script>

      const form = document.getElementById('form');

      function createPreviews(event) {
        let previewDiv = document.getElementById('img-previews');
        previewDiv.style.display = 'flex';
        while (previewDiv.firstChild) {
          previewDiv.removeChild(previewDiv.lastChild);
        }
        for (i = 0; i < form.files.files.length; i++) {

          let imgContainer = document.createElement('div');
          imgContainer.className += 'img-preview-container';
          let imgNode = document.createElement('img');
          imgNode.src = window.URL.createObjectURL(event.target.files[i]);
          imgNode.className += 'img-preview'; 

          imgContainer.appendChild(imgNode);
          previewDiv.appendChild(imgContainer);
          imgNode.onload = function() {
            URL.revokeObjectURL(imgNode.src) // free memory
          }
        }
      }

      let tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
      let tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl)
      })

      form.addEventListener('submit', e => {
        e.preventDefault();

        let body = JSON.stringify({
          // complainant: form.complainant.value,
          complainant: '',
          complainee: form.complainee.value,
          linked: form.url.value,
          reason: form.reason.value,
          description: form.description.value,
          mimeTypes: null,
          files: null
        });

        console.log("BODYPRE");
        console.log(body);

        if (form.files.files.length == 0) {
          console.log("FILES ARE EMPTY; RETURNING");
          sendPost(body);
          return;
        }

        let mimeTypes = [];
        let files = [];
        let numOfFiles = form.files.files.length;

        for (i = 0; i < numOfFiles; i++) {
          file = form.files.files[i];

          fr = new FileReader();
          fr.readAsArrayBuffer(file);

          fr.onload = (f) => {
            console.log(JSON.stringify([...new Int8Array(f.target.result)]));
            files.push(JSON.stringify([...new Int8Array(f.target.result)]));
            mimeTypes.push(file.type);

            if (files.length == numOfFiles) { 
              body = JSON.stringify({
                // complainant: form.complainant.value,
                complainant: '',
                complainee: form.complainee.value,
                linked: form.url.value,
                reason: form.reason.value,
                description: form.description.value,
                mimeTypes: mimeTypes,
                files: files
              });
              console.log("BODYPOST");
              console.log(body);
              sendPost(body);
              return;
            }

          };
        }

      });
      
      function sendPost(body) {
        const url = "https://script.google.com/macros/s/AKfycbwjRkB3aUF2u7qFoS75d6fHHiQOdT_SafsbUXbHinPsZVYqrcTGau80MnE6Ai1irJwb/exec";

        fetch(url, {method: "POST", body: body})
        .then(res => res.json())
        .then(e => console.log(e))
        .catch(err => console.log(err));
      }

    </script>

  </body>
  
</html>
